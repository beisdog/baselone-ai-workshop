<mat-progress-spinner *ngIf="loading"
                      mode="indeterminate"
                      color="primary"
                      class="loading-spinner"
></mat-progress-spinner>
<mat-card #chatContainer class="chat-container">
  <mat-card-content>

    <div class="messages-container" #scrollContainer>

      <mat-card *ngFor="let message of messages"
                class="message-card"
                [ngClass]="{'user-message': message.type === 'user', 'bot-message': message.type === 'assistant'}">
        <mat-card-content>
          <div [innerHTML]="message.text | markdown"></div>

          <!-- Search Results Button -->
          <div class="message-actions" *ngIf="hasSearchResults(message)">
            <button mat-stroked-button
                    color="primary"
                    (click)="showMessageSearchResults(message)"
                    class="search-results-btn">
              <mat-icon>search</mat-icon>
              View Search Results ({{ message.searchResults!.length }})
            </button>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  </mat-card-content>
  <mat-divider></mat-divider>
  <mat-card-actions>
    <form [formGroup]="chatForm" novalidate class="chat-input-form">
      <div class="chat-input-form-row1">
        <mat-form-field class="chat-input-field" appearance="outline">
      <textarea style="width: 100%" matInput formControlName="userInput" placeholder="Type your message..."
                (keydown.enter)="ask()">
      </textarea>
        </mat-form-field>
        <mat-form-field>
          <mat-label>LLM Model</mat-label>
          <mat-select formControlName="selectedLlm">
            <mat-option [value]="null">Kein LLM Modell ausgew채hlt</mat-option>
            <mat-option *ngFor="let llm of llmModels" [value]="llm.id">
              {{ llm.id }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-icon-button color="primary" (click)="ask()" class="chat-send-btn">
          <mat-icon>send</mat-icon>
        </button>
        @if(chatForm.value.visibleVersion > 1) {
          <mat-checkbox formControlName="useHistory">Use History</mat-checkbox>
        }
      </div>
      <div class="chat-input-form-row1">
        <mat-form-field>
          <mat-label>Version</mat-label>
          <mat-select formControlName="visibleVersion">
            <mat-option *ngFor="let version of [1,2,3,4,5]" [value]="version">
              {{ version }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        @if(chatForm.value.visibleVersion > 2) {
          <mat-form-field>
            <mat-label>Benutzer ausw채hlen</mat-label>
            <mat-select formControlName="selectedProfile">
              <mat-option [value]="null">Kein CV ausgew채hlt</mat-option>
              <mat-option *ngFor="let profile of profiles" [value]="profile.id">
                {{ profile.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="askAboutCV()" class="chat-send-btn"
                  [disabled]="!chatForm.value.selectedProfile">
            Ask concerning CV
          </button>
        }
      </div>
      <div class="chat-input-form-row1">
        @if(chatForm.value.visibleVersion > 3) {
        <mat-form-field>
          <mat-label>Vector Store Namespace</mat-label>
          <mat-select formControlName="selectedVSNamespace">
            <mat-option [value]="null">Kein Vectorstore namespace ausgew채hlt</mat-option>
            <mat-option *ngFor="let ns of vsNamespaces" [value]="ns">
              {{ ns }}
            </mat-option>
          </mat-select>
        </mat-form-field>
          <mat-form-field>
            <mat-label>Max Results</mat-label>
            <mat-select formControlName="maxResults">
              <mat-option *ngFor="let m of [1,3,5,10,20,30,40,50]" [value]="m">
                {{ m }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        <button mat-raised-button color="primary" (click)="askAboutCVList()" class="chat-send-btn"
                [disabled]="!chatForm.value.selectedVSNamespace">
          Ask with CV Search
        </button>
          <button mat-raised-button color="accent" (click)="performVectorSearch()" class="chat-send-btn"
                  [disabled]="!chatForm.value.selectedVSNamespace || !chatForm.value.userInput">
            Vector Search
          </button>
          <button mat-stroked-button (click)="clearSearchResults()" class="chat-send-btn"
                  *ngIf="searchResults.length > 0">
            Clear Results
          </button>
        }


      </div>
    </form>
  </mat-card-actions>

  <!-- Search Results Section -->
  @if (chatForm.value.visibleVersion > 3) {
    <app-search-results
      [searchResults]="searchResults"
      [loading]="searchLoading"
      [searchQuery]="lastSearchQuery"
      *ngIf="searchResults.length > 0 || searchLoading || lastSearchQuery">
    </app-search-results>
  }

</mat-card>
